<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0 auto;
      max-width: 600px;
      padding: 20px;
      background-color: #f8f9fa;
      color: #343a40;
    }
    h1 {
      text-align: center;
      color: #007bff;
      margin-bottom: 20px;
      font-weight: 700;
    }
    .sensor-data, .stats, .emotion-selection, .warning, #predictionResult {
      border-radius: 8px;
      margin: 15px 0;
      padding: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .stats {
      background: #e9f5ff;
      border: 1px solid #cce5ff;
    }
    .sensor-data {
      background: #fff3e0;
      border: 1px solid #ffcc80;
      font-size: 0.9em;
    }
    .emotion-selection {
      background: #e6f7ff;
      border: 1px solid #99d8ff;
    }
    .warning {
      background: #fff0f0;
      border: 1px solid #f8d7da;
      color: #721c24;
      font-weight: 600;
    }
    textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #ced4da;
      border-radius: 8px;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    textarea:focus {
      border-color: #007bff;
      outline: none;
    }
    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    button {
      flex: 1;
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background 0.3s, transform 0.1s;
    }
    button:hover {
      background: #0056b3;
    }
    button:active {
      transform: translateY(1px);
    }
    #predictionResult {
      font-size: 1.2em;
      font-weight: bold;
      text-align: center;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
      border: 1px solid #ccc;
      transition: background-color 0.5s;
    }
    .emotion-happy { background-color: #ffeb3b; } /* å–œ */
    .emotion-angry { background-color: #f44336; color: white; } /* æ€’ */
    .emotion-sad { background-color: #2196f3; color: white; } /* å“€ */
    .emotion-fun { background-color: #4caf50; color: white; } /* æ¥½ */
    .emotion-default { background-color: #e9ecef; }
    @media (max-width: 480px) {
      body { padding: 10px; }
      .button-container { flex-direction: column; }
    }
  </style>
</head>
<body>
  <h1>ğŸ“± ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>
  
  <div class="warning">
    <strong>æ³¨æ„:</strong> åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã¾ãŸã¯ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
  </div>
  
  <textarea id="typingArea" rows="6" placeholder="ã“ã“ã«ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã¦ãã ã•ã„"></textarea>
  
  <div class="stats">
    <p><strong>ğŸ“ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°æ•°:</strong> <span id="typeCount">0</span></p>
    <p><strong>ğŸ”™ å‰Šé™¤å›æ•° (Backspace):</strong> <span id="deleteCount">0</span></p>
    <p><strong>â± æ‰“ã¡è¾¼ã¿æ™‚é–“:</strong> <span id="typingTime">0.0</span> ç§’</p>
  </div>
  
  <div class="sensor-data">
    <p><strong>ğŸ“Š æœ€å¤§åŠ é€Ÿåº¦ (çµ¶å¯¾å€¤):</strong></p>
    <p>Max X: <span id="maxAccelX">0.00</span></p>
    <p>Max Y: <span id="maxAccelY">0.00</span></p>
    <p>Max Z: <span id="maxAccelZ">0.00</span></p>
    <div id="sensorStatus"></div>
  </div>
  
  <div class="emotion-selection">
    <p><strong>ğŸ˜Š ä»Šã®æ„Ÿæƒ…ã‚’é¸ã‚“ã§ãã ã•ã„: (è¨˜éŒ²ç”¨)</strong></p>
    <label><input type="radio" name="emotion" value="å–œ"> ğŸ˜Š å–œ</label>
    <label><input type="radio" name="emotion" value="æ€’"> ğŸ˜  æ€’</label>
    <label><input type="radio" name="emotion" value="å“€"> ğŸ˜¢ å“€</label>
    <label><input type="radio" name="emotion" value="æ¥½"> ğŸ˜„ æ¥½</label>
  </div>
  
  <div class="button-container">
    <button id="saveBtn">ğŸ’¾ ä¿å­˜ & æ„Ÿæƒ…äºˆæ¸¬</button>
    <button id="resetBtn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div id="predictionResult" class="emotion-default">
    ã“ã“ã«äºˆæ¸¬ã•ã‚ŒãŸæ„Ÿæƒ…ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
  </div>

  <!-- ----------------- ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆCORSå›é¿ç”¨ï¼‰ ----------------- -->
  <form id="typingForm" method="POST" action="https://script.google.com/macros/s/YOUR_GAS_ID/exec">
    <input type="hidden" name="text" id="formText">
    <input type="hidden" name="typeCount" id="formTypeCount">
    <input type="hidden" name="deleteCount" id="formDeleteCount">
    <input type="hidden" name="typingTime" id="formTypingTime">
    <input type="hidden" name="accelX" id="formAccelX">
    <input type="hidden" name="accelY" id="formAccelY">
    <input type="hidden" name="accelZ" id="formAccelZ">
    <input type="hidden" name="emotion" id="formEmotion">
    <input type="hidden" name="predictedEmotion" id="formPredictedEmotion">
    <input type="hidden" name="timestamp" id="formTimestamp">
  </form>

  <script>
    const typingArea = document.getElementById('typingArea');
    const typeCountSpan = document.getElementById('typeCount');
    const deleteCountSpan = document.getElementById('deleteCount');
    const typingTimeSpan = document.getElementById('typingTime');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const sensorStatus = document.getElementById('sensorStatus');
    const predictionResultDiv = document.getElementById('predictionResult');
    const maxAccelXSpan = document.getElementById('maxAccelX');
    const maxAccelYSpan = document.getElementById('maxAccelY');
    const maxAccelZSpan = document.getElementById('maxAccelZ');

    let typeCount = 0;
    let deleteCount = 0;
    let startTime = null;
    let timer = null;
    let maxAccelX = 0, maxAccelY = 0, maxAccelZ = 0;

    typingArea.addEventListener('keydown', (e) => {
      if (!startTime) {
        startTime = Date.now();
        timer = setInterval(() => {
          typingTimeSpan.textContent = ((Date.now() - startTime) / 1000).toFixed(1);
        }, 100);
      }
      if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
        typeCount++;
        typeCountSpan.textContent = typeCount;
      } else if (e.key === 'Backspace') {
        deleteCount++;
        deleteCountSpan.textContent = deleteCount;
      }
    });

    typingArea.addEventListener('blur', () => { if (timer) clearInterval(timer); });
    typingArea.addEventListener('focus', () => {
      if (startTime && !timer) {
        timer = setInterval(() => {
          typingTimeSpan.textContent = ((Date.now() - startTime) / 1000).toFixed(1);
        }, 100);
      }
    });

    if (window.DeviceMotionEvent) {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        sensorStatus.innerHTML = '<button onclick="requestSensorPermission()">ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã‚’å–å¾—</button>';
      } else { startSensorTracking(); }
    } else {
      sensorStatus.innerHTML = '<p style="color: red;">åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
    }

    window.requestSensorPermission = function() {
      DeviceMotionEvent.requestPermission()
        .then(permissionState => {
          if (permissionState === 'granted') {
            startSensorTracking();
            sensorStatus.innerHTML = '<p style="color: green;">ã‚»ãƒ³ã‚µãƒ¼è¨±å¯æ¸ˆã¿ âœ“</p>';
          } else { sensorStatus.innerHTML = '<p style="color: red;">ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ</p>'; }
        })
        .catch(err => {
          console.error(err);
          sensorStatus.innerHTML = '<p style="color: red;">ã‚»ãƒ³ã‚µãƒ¼è¨±å¯å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>';
        });
    }

    function startSensorTracking() {
      window.addEventListener('devicemotion', (event) => {
        const accelX = event.accelerationIncludingGravity.x || 0;
        const accelY = event.accelerationIncludingGravity.y || 0;
        const accelZ = event.accelerationIncludingGravity.z || 0;
        if (Math.abs(accelX) > Math.abs(maxAccelX)) maxAccelX = accelX;
        if (Math.abs(accelY) > Math.abs(maxAccelY)) maxAccelY = accelY;
        if (Math.abs(accelZ) > Math.abs(maxAccelZ)) maxAccelZ = accelZ;
        maxAccelXSpan.textContent = Math.abs(maxAccelX).toFixed(2);
        maxAccelYSpan.textContent = Math.abs(maxAccelY).toFixed(2);
        maxAccelZSpan.textContent = Math.abs(maxAccelZ).toFixed(2);
      });
      if (!sensorStatus.innerHTML.includes('è¨±å¯æ¸ˆã¿')) {
        sensorStatus.innerHTML = '<p style="color: green;">ã‚»ãƒ³ã‚µãƒ¼å‹•ä½œä¸­ âœ“</p>';
      }
    }

    function predictAndDisplayEmotion() {
      const overallMaxAccel = Math.max(Math.abs(maxAccelX), Math.abs(maxAccelY), Math.abs(maxAccelZ));
      const currentTypingTime = parseFloat(typingTimeSpan.textContent);
      const deletionRate = currentTypingTime > 0 ? deleteCount / currentTypingTime : 0;
      const THRESHOLD_ACCEL = 5.0;
      const THRESHOLD_DELETION = 0.5;
      let predictedEmotion = "ä¸æ˜";
      let emotionClass = "emotion-default";
      const isStrongTyping = overallMaxAccel > THRESHOLD_ACCEL;
      const isHighDeletionRate = deletionRate >= THRESHOLD_DELETION;

      if (isHighDeletionRate) {
          predictedEmotion = isStrongTyping ? "æ€’" : "å“€";
          emotionClass = isStrongTyping ? "emotion-angry" : "emotion-sad";
      } else {
          predictedEmotion = isStrongTyping ? "å–œ" : "æ¥½";
          emotionClass = isStrongTyping ? "emotion-happy" : "emotion-fun";
      }

      predictionResultDiv.textContent = `äºˆæ¸¬ã•ã‚ŒãŸæ„Ÿæƒ…: ${predictedEmotion} (${overallMaxAccel.toFixed(2)}m/sÂ², ${deletionRate.toFixed(2)}å›/ç§’)`;
      predictionResultDiv.className = '';
      predictionResultDiv.classList.add(emotionClass);
    }

    saveBtn.addEventListener('click', () => {
      predictAndDisplayEmotion();
      const emotion = document.querySelector('input[name="emotion"]:checked');
      if (!emotion) { alert('ã¾ãšã€Œä»Šã®æ„Ÿæƒ…ã€ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

      document.getElementById('formText').value = typingArea.value;
      document.getElementById('formTypeCount').value = typeCount;
      document.getElementById('formDeleteCount').value = deleteCount;
      document.getElementById('formTypingTime').value = typingTimeSpan.textContent;
      document.getElementById('formAccelX').value = maxAccelX;
      document.getElementById('formAccelY').value = maxAccelY;
      document.getElementById('formAccelZ').value = maxAccelZ;
      document.getElementById('formEmotion').value = emotion.value;
      document.getElementById('formPredictedEmotion').value = predictionResultDiv.textContent.split(' ')[1];
      document.getElementById('formTimestamp').value = new Date().toISOString();

      document.getElementById('typingForm').submit();
    });

    resetBtn.addEventListener('click', () => {
      if (!confirm('å…¥åŠ›å†…å®¹ã¨è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
      typingArea.value = '';
      typeCount = deleteCount = 0;
      startTime = null;
      maxAccelX = maxAccelY = maxAccelZ = 0;
      typeCountSpan.textContent = '0';
      deleteCountSpan.textContent = '0';
      typingTimeSpan.textContent = '0.0';
      maxAccelXSpan.textContent = maxAccelYSpan.textContent = maxAccelZSpan.textContent = '0.00';
      document.querySelectorAll('input[name="emotion"]').forEach(r => r.checked = false);
      if (timer) { clearInterval(timer); timer = null; }
      predictionResultDiv.textContent = 'ã“ã“ã«äºˆæ¸¬ã•ã‚ŒãŸæ„Ÿæƒ…ãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
      predictionResultDiv.className = 'emotion-default';
    });
  </script>
</body>
</html>
