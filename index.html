<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0 auto;
      max-width: 600px;
      padding: 20px;
      background-color: #f8f9fa;
      color: #343a40;
    }
    h1 {
      text-align: center;
      color: #007bff;
      margin-bottom: 20px;
      font-weight: 700;
    }
    .sensor-data, .stats, .emotion-selection, .warning, #predictionResult {
      border-radius: 8px;
      margin: 15px 0;
      padding: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .stats {
      background: #e9f5ff;
      border: 1px solid #cce5ff;
    }
    .sensor-data {
      background: #fff3e0;
      border: 1px solid #ffcc80;
      font-size: 0.9em;
    }
    .emotion-selection {
      background: #e6f7ff;
      border: 1px solid #99d8ff;
    }
    .warning {
      background: #fff0f0;
      border: 1px solid #f8d7da;
      color: #721c24;
      font-weight: 600;
    }
    textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #ced4da;
      border-radius: 8px;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    textarea:focus {
      border-color: #007bff;
      outline: none;
    }
    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    button {
      flex: 1;
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background 0.3s, transform 0.1s;
    }
    button:hover {
      background: #0056b3;
    }
    button:active {
      transform: translateY(1px);
    }
    #predictionResult {
      font-size: 1.2em;
      font-weight: bold;
      text-align: center;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
      border: 1px solid #ccc;
      transition: background-color 0.5s;
    }
    .emotion-happy { background-color: #ffeb3b; } /* å–œ */
    .emotion-angry { background-color: #f44336; color: white; } /* æ€’ */
    .emotion-sad { background-color: #2196f3; color: white; } /* å“€ */
    .emotion-fun { background-color: #4caf50; color: white; } /* æ¥½ */
    .emotion-default { background-color: #e9ecef; }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      .button-container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ“± ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>
  
  <div class="warning">
    <strong>æ³¨æ„:</strong> åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã¾ãŸã¯ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
  </div>
  
  <textarea id="typingArea" rows="6" placeholder="ã“ã“ã«ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã¦ãã ã•ã„"></textarea>
  
  <div class="stats">
    <p><strong>ğŸ“ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°æ•°:</strong> <span id="typeCount">0</span></p>
    <p><strong>ğŸ”™ å‰Šé™¤å›æ•° (Backspace):</strong> <span id="deleteCount">0</span></p>
    <p><strong>â± æ‰“ã¡è¾¼ã¿æ™‚é–“:</strong> <span id="typingTime">0.0</span> ç§’</p>
  </div>
  
  <div class="sensor-data">
    <p><strong>ğŸ“Š æœ€å¤§åŠ é€Ÿåº¦ (çµ¶å¯¾å€¤):</strong></p>
    <p>Max X: <span id="maxAccelX">0.00</span></p>
    <p>Max Y: <span id="maxAccelY">0.00</span></p>
    <p>Max Z: <span id="maxAccelZ">0.00</span></p>
    <div id="sensorStatus"></div>
  </div>
  
  <div class="emotion-selection">
    <p><strong>ğŸ˜Š ä»Šã®æ„Ÿæƒ…ã‚’é¸ã‚“ã§ãã ã•ã„: (è¨˜éŒ²ç”¨)</strong></p>
    <label><input type="radio" name="emotion" value="å–œ"> ğŸ˜Š å–œ</label>
    <label><input type="radio" name="emotion" value="æ€’"> ğŸ˜  æ€’</label>
    <label><input type="radio" name="emotion" value="å“€"> ğŸ˜¢ å“€</label>
    <label><input type="radio" name="emotion" value="æ¥½"> ğŸ˜„ æ¥½</label>
  </div>
  
  <div class="button-container">
    <button id="saveBtn">ğŸ’¾ ä¿å­˜ & æ„Ÿæƒ…äºˆæ¸¬</button>
    <button id="resetBtn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div id="predictionResult" class="emotion-default">
    ã“ã“ã«äºˆæ¸¬ã•ã‚ŒãŸæ„Ÿæƒ…ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
  </div>

  <script>
    const typingArea = document.getElementById('typingArea');
    const typeCountSpan = document.getElementById('typeCount');
    const deleteCountSpan = document.getElementById('deleteCount');
    const typingTimeSpan = document.getElementById('typingTime');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const sensorStatus = document.getElementById('sensorStatus');
    const predictionResultDiv = document.getElementById('predictionResult');
    const maxAccelXSpan = document.getElementById('maxAccelX');
    const maxAccelYSpan = document.getElementById('maxAccelY');
    const maxAccelZSpan = document.getElementById('maxAccelZ');

    let typeCount = 0;
    let deleteCount = 0;
    let startTime = null;
    let timer = null;
    let maxAccelX = 0, maxAccelY = 0, maxAccelZ = 0;

    /**
     * ã‚¿ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹/ã‚­ãƒ¼ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
     */
    typingArea.addEventListener('keydown', (e) => {
      // åˆå›ã‚­ãƒ¼å…¥åŠ›æ™‚ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆ
      if (!startTime) {
        startTime = Date.now();
        timer = setInterval(() => {
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
          typingTimeSpan.textContent = elapsed;
        }, 100);
      }
      
      // æ–‡å­—å…¥åŠ›ã®ã‚«ã‚¦ãƒ³ãƒˆ
      if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
        typeCount++;
        typeCountSpan.textContent = typeCount;
      } 
      // Backspaceï¼ˆå‰Šé™¤ï¼‰ã®ã‚«ã‚¦ãƒ³ãƒˆ
      else if (e.key === 'Backspace') {
        deleteCount++;
        deleteCountSpan.textContent = deleteCount;
      }
    });

    typingArea.addEventListener('blur', () => {
      if (timer) clearInterval(timer);
    });

    typingArea.addEventListener('focus', () => {
      if (startTime && !timer) {
        timer = setInterval(() => {
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
          typingTimeSpan.textContent = elapsed;
        }, 100);
      }
    });


    /**
     * åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã¨ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°é–‹å§‹
     */
    if (window.DeviceMotionEvent) {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        sensorStatus.innerHTML = '<button onclick="requestSensorPermission()">ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã‚’å–å¾—</button>';
      } else {
        startSensorTracking();
      }
    } else {
      sensorStatus.innerHTML = '<p style="color: red;">åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
    }

    window.requestSensorPermission = function() {
      DeviceMotionEvent.requestPermission()
        .then(permissionState => {
          if (permissionState === 'granted') {
            startSensorTracking();
            sensorStatus.innerHTML = '<p style="color: green;">ã‚»ãƒ³ã‚µãƒ¼è¨±å¯æ¸ˆã¿ âœ“</p>';
          } else {
            sensorStatus.innerHTML = '<p style="color: red;">ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ</p>';
          }
        })
        .catch(err => {
            console.error(err);
            sensorStatus.innerHTML = '<p style="color: red;">ã‚»ãƒ³ã‚µãƒ¼è¨±å¯å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>';
        });
    }

    function startSensorTracking() {
      window.addEventListener('devicemotion', (event) => {
        // é‡åŠ›ã‚’å«ã‚€åŠ é€Ÿåº¦ã‚’å–å¾—
        const accelX = event.accelerationIncludingGravity.x || 0;
        const accelY = event.accelerationIncludingGravity.y || 0;
        const accelZ = event.accelerationIncludingGravity.z || 0;
        
        // æœ€å¤§å€¤ã®æ›´æ–°ï¼ˆçµ¶å¯¾å€¤ã§æ¯”è¼ƒï¼‰
        if (Math.abs(accelX) > Math.abs(maxAccelX)) maxAccelX = accelX;
        if (Math.abs(accelY) > Math.abs(maxAccelY)) maxAccelY = accelY;
        if (Math.abs(accelZ) > Math.abs(maxAccelZ)) maxAccelZ = accelZ;
        
        // æœ€å¤§å€¤ã®è¡¨ç¤ºã‚’æ›´æ–°
        maxAccelXSpan.textContent = Math.abs(maxAccelX).toFixed(2);
        maxAccelYSpan.textContent = Math.abs(maxAccelY).toFixed(2);
        maxAccelZSpan.textContent = Math.abs(maxAccelZ).toFixed(2);
      });
      
      if (!sensorStatus.innerHTML.includes('è¨±å¯æ¸ˆã¿')) {
        sensorStatus.innerHTML = '<p style="color: green;">ã‚»ãƒ³ã‚µãƒ¼å‹•ä½œä¸­ âœ“</p>';
      }
    }


    /**
     * æ„Ÿæƒ…ã‚’äºˆæ¸¬ã—ã¦è¡¨ç¤ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ (äºŒé …åˆ†é¡)
     */
    function predictAndDisplayEmotion() {
      // (1) ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã®å¼·ã• (Max Accelã®æœ€å¤§çµ¶å¯¾å€¤)
      const overallMaxAccel = Math.max(Math.abs(maxAccelX), Math.abs(maxAccelY), Math.abs(maxAccelZ));
      
      // (2) ç§’é–“å‰Šé™¤å›æ•° (å‰Šé™¤ã®å¤šã•)
      const currentTypingTime = parseFloat(typingTimeSpan.textContent);
      const deletionRate = currentTypingTime > 0 ? deleteCount / currentTypingTime : 0;

      // --- é–¾å€¤è¨­å®šï¼ˆã“ã®å€¤ã‚’èª¿æ•´ã—ã¦ç²¾åº¦ã‚’ä¸Šã’ã¦ãã ã•ã„ï¼‰ ---
      const THRESHOLD_ACCEL = 5.0; // ã“ã‚Œã‚ˆã‚Šå¤§ãã„ã¨ã€Œå¼·ã„ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã€ (m/s^2)
      const THRESHOLD_DELETION = 0.5; // ç§’é–“0.5å›ä»¥ä¸Šã§ã€Œå‰Šé™¤ãŒå¤šã„ã€

      let predictedEmotion = "ä¸æ˜";
      let emotionClass = "emotion-default";

      // äºŒé …åˆ†é¡ã®åˆ¤å®š
      const isStrongTyping = overallMaxAccel > THRESHOLD_ACCEL;
      const isHighDeletionRate = deletionRate >= THRESHOLD_DELETION;

      /*
        äºˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯ (2x2ãƒãƒˆãƒªãƒƒã‚¯ã‚¹):
        +------------------+------------------+------------------+
        |                  | å‰Šé™¤ãŒå¤šã„ (High)  | å‰Šé™¤ãŒå°‘ãªã„ (Low) |
        +------------------+------------------+------------------+
        | å¼·ã„ã‚¿ã‚¤ãƒ”ãƒ³ã‚° (Strong) | æ€’ (Angry)         | å–œ (Happy)         |
        +------------------+------------------+------------------+
        | å¼±ã„ã‚¿ã‚¤ãƒ”ãƒ³ã‚° (Weak)  | å“€ (Sad)           | æ¥½ (Fun/Relaxed)   |
        +------------------+------------------+------------------+
      */

      if (isHighDeletionRate) { // å‰Šé™¤ãŒå¤šã„å ´åˆ
          if (isStrongTyping) {
              predictedEmotion = "æ€’"; // å¼·ã„ã‚¿ã‚¤ãƒ”ãƒ³ã‚° + å‰Šé™¤ãŒå¤šã„
              emotionClass = "emotion-angry";
          } else { 
              predictedEmotion = "å“€"; // å¼±ã„ã‚¿ã‚¤ãƒ”ãƒ³ã‚° + å‰Šé™¤ãŒå¤šã„
              emotionClass = "emotion-sad";
          }
      } else { // å‰Šé™¤ãŒå°‘ãªã„å ´åˆ
          if (isStrongTyping) {
              predictedEmotion = "å–œ"; // å¼·ã„ã‚¿ã‚¤ãƒ”ãƒ³ã‚° + å‰Šé™¤ãŒå°‘ãªã„
              emotionClass = "emotion-happy";
          } else { 
              predictedEmotion = "æ¥½"; // å¼±ã„ã‚¿ã‚¤ãƒ”ãƒ³ã‚° + å‰Šé™¤ãŒå°‘ãªã„
              emotionClass = "emotion-fun";
          }
      }

      // çµæœã‚’è¡¨ç¤º
      predictionResultDiv.textContent = `äºˆæ¸¬ã•ã‚ŒãŸæ„Ÿæƒ…: ${predictedEmotion} (${overallMaxAccel.toFixed(2)}m/sÂ², ${deletionRate.toFixed(2)}å›/ç§’)`;
      predictionResultDiv.className = ''; 
      predictionResultDiv.classList.add(emotionClass); 
    }

    /**
     * ä¿å­˜ãƒœã‚¿ãƒ³å‡¦ç† (GASã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡)
     */
    saveBtn.addEventListener('click', () => {
      // æ„Ÿæƒ…ã‚’äºˆæ¸¬ã—ã¦è¡¨ç¤º
      predictAndDisplayEmotion(); 

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸæ„Ÿæƒ…ã‚‚å–å¾— (è¨˜éŒ²ç”¨)
      const emotion = document.querySelector('input[name="emotion"]:checked');
      
      if (!emotion) {
          alert('ä¿å­˜ã™ã‚‹ã«ã¯ã€ã¾ãšã€Œä»Šã®æ„Ÿæƒ…ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          return;
      }
      
      const data = {
        text: typingArea.value,
        typeCount: typeCount,
        deleteCount: deleteCount,
        typingTime: typingTimeSpan.textContent,
        maxAccel: { x: maxAccelX, y: maxAccelY, z: maxAccelZ },
        emotion: emotion.value, // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸæ„Ÿæƒ…
        predictedEmotion: predictionResultDiv.textContent.split(': ')[1].split(' ')[0], // äºˆæ¸¬çµæœã‹ã‚‰æ„Ÿæƒ…ã ã‘ã‚’æŠ½å‡º
        timestamp: new Date().toISOString()
      };
      
      // â˜…â˜…â˜…ã€æœ€é‡è¦ã€‘æ³¨æ„: ã“ã“ã«ã‚ãªãŸã®æœ€æ–°ã®Google Apps Script Webã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ â˜…â˜…â˜…
      // ã“ã®URLãŒæ­£ã—ããªã„ã¨ã€ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
      const gasUrl = 'https://script.google.com/macros/s/AKfycbyvp6LnIRFKxQ29T4HmS0AWiAYFCcXLHTStVjIO_eJ5RAtg4J4LhruBPbgW-iY50N1R/exec';
      console.log('GASã¸ã®é€ä¿¡URL:', gasUrl); 
      console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', data); 

      // Google Apps Scriptã®Web APIã«é€ä¿¡
      fetch(gasUrl, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(async (res) => {
        if (!res.ok) { 
          const errorText = await res.text(); 
          console.error(`GASå¿œç­”ã‚¨ãƒ©ãƒ¼: HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ${res.status} ${res.statusText}. å¿œç­”ãƒœãƒ‡ã‚£: ${errorText}`);
          throw new Error(`GASå¿œç­”ã‚¨ãƒ©ãƒ¼: HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ${res.status}ã€‚URLã€ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã€ã¾ãŸã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        }
        return res.text();
      })
      .then(msg => {
        alert('ãƒ‡ãƒ¼ã‚¿ã‚’Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã—ãŸï¼GASã‹ã‚‰ã®å¿œç­”: ' + msg); 
        // æˆåŠŸå¾Œã€ãƒªã‚»ãƒƒãƒˆã‚’ææ¡ˆ
        document.getElementById('resetBtn').click();
      })
      .catch(err => {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
        alert('GASã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®è©³ç´°ã¨ã€GASã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼: ' + err.message); 
      });
    });

    /**
     * ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³å‡¦ç†
     */
    resetBtn.addEventListener('click', () => {
      if (confirm('å…¥åŠ›å†…å®¹ã¨è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        typingArea.value = '';
        typeCount = 0;
        deleteCount = 0;
        startTime = null;
        maxAccelX = maxAccelY = maxAccelZ = 0; // æœ€å¤§åŠ é€Ÿåº¦ã‚‚ãƒªã‚»ãƒƒãƒˆ
        
        typeCountSpan.textContent = '0';
        deleteCountSpan.textContent = '0';
        typingTimeSpan.textContent = '0.0';
        maxAccelXSpan.textContent = '0.00';
        maxAccelYSpan.textContent = '0.00';
        maxAccelZSpan.textContent = '0.00';
        
        document.querySelectorAll('input[name="emotion"]').forEach(radio => {
          radio.checked = false;
        });
        
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
        
        predictionResultDiv.textContent = 'ã“ã“ã«äºˆæ¸¬ã•ã‚ŒãŸæ„Ÿæƒ…ãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
        predictionResultDiv.className = 'emotion-default'; 
      }
    });
  </script>
</body>
</html>